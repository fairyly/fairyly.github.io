<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>添加水印</title>
    <meta name="viewport" content="width=640,user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="海报首页">
    <link rel="stylesheet" type="text/css" href="css/addswiper.css">
    <link rel="stylesheet" type="text/css" href="font/iconfont.css">
    <script src="js/jquery-2.2.3.min.js"></script>
    <script src="js/edit_1.js"></script>
    <script src="js/touch.min.js"></script>
    <script src="js/touch.js"></script>
    <script src="js/htc.js"></script>
   <script type="text/javascript">
        var docEl = document.documentElement,
            //总来的来就是监听当然窗口的变化，一旦有变化就需要重新设置根字体的值
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function() {
                //设置根字体大小
                docEl.style.fontSize = 10 * (docEl.clientWidth / 320) + 'px';
            };
        //绑定浏览器缩放与加载时间
        window.addEventListener(resizeEvt, recalc, false);
        document.addEventListener('DOMContentLoaded', recalc, false);
    </script>
</head>
<body style="background: #232323;">
  <div class="first">
    <div class="header">
        <nav>
            <div class="nav">
                <ul>
                    <li style="width:28%"><a href="mark.html">返回</a></li>
                    <li style="width:45%"><a href="">添加水印</a></li>
                    <li style="width:22%"><a href="mark.html">首页</a></li>
                </ul>
            </div>
        </nav>
    </div> 
    <div class="watermark">
        <!-- 第一步：上传图片 -->
        <div id="add" class="add">
          <form method="post" action="upload_watermark_pic" enctype="multipart/form-data">
            <input name="file" type="file" accept="image/*" id="markimg">
          </form>
        </div>
        <!-- 第二步：显示图片 -->
        <div class="addsteptwo">
          <div class="markmain" id="markmain" style="padding-bottom: 0px;top: 0px;margin-top: 7rem;">
            <img id="addpic" src="">
          </div>
          <button id="addmark" class="addmark">
            <span>添加水印</span>
          </button>
          <button id="shengchengmark" class="shengchengmark">
            <span>生成</span>
          </button>
        </div>
         <!-- 第三步：选择水印 -->
        <ul class="masklist" id="masklist"> 
                <li data-index="0">
                    <div class="mod-mark" style="background-image: url(./images/waterstyle001_bg.png);background-position: 0rem 0rem;">
                      <h3 style="width: 16.54rem;height:2.104rem;line-height:2.104rem;left:0rem;top:4.887rem;color:#FFFFFF;text-align:center;">加水印</h3>
                      <p style="left:0rem;top:8.0282rem;width:15.34rem;height:1.5134rem;line-height:1.5134rem;color:#FFFFFF;text-align:center;">微信：aqf</p>
                    </div>
                </li>
            
                <li data-index="1">
                    <div class="mod-mark" style="background-image: url(./images/waterstyle001_bg.png);background-position: 0rem 0rem;">
                      <h3 style="width: 16.54rem;height:2.104rem;line-height:2.104rem;left:0rem;top:4.887rem;color:#FFFFFF;text-align:center;">加水印</h3>
                      <p style="left:0rem;top:8.0282rem;width:15.34rem;height:1.5134rem;line-height:1.5134rem;color:#FFFFFF;text-align:center;">微信：aqf</p>
                    </div>
                </li>
            
                <li data-index="2">
                    <div class="mod-mark" ><!--style="background-image: url(images/waterstyle168_bg.png);background-position: 0rem 0rem;"-->
                      <div style="position:absolute;width: 16.64rem;" class="markdiv"><img src="images/waterstyle168_bg.png" style="width:16.64rem;height:auto"></div>
                      <h3 style="width: 11.4259rem;height:2.3104rem;line-height:2.3104rem;left:1.45776rem;top:4.6499rem;color:#231f20;text-align:center;" class="markh3">加水印</h3>
                      <p style="left:1.05776rem;top:6.9991rem;width:12.4259rem;height:1.62134rem;line-height:1.62134rem;color:#231f20;text-align:center;" class="markp">微信：aqf</p>
                    </div>
                </li>
            
                <li data-index="3">
                    <div class="mod-mark"><!-- style="background-image: url(./images/waterstyle166_bg.png);background-position: 0rem 3.24559rem;"-->
                      <div style="position:absolute;width: 16.64rem;top:3.24559rem"><img src="images/waterstyle166_bg.png" style="width:16.64rem;height:auto"></div>
                      <h3 style="width: 15.94rem;height:2.3104rem;line-height:2.3104rem;left:0rem;top:8.40767rem;color:#ffffff;text-align:center;">加水印</h3>
                      <p style="left:0rem;top:10.3871rem;width:15.94rem;height:1.62134rem;line-height:1.62134rem;color:#ffffff;text-align:center;">微信：aqf</p>
                    </div>
                </li>
                <li data-index="4">
                    <div class="mod-mark" ><!--style="background-image: url(./images/waterstyle165_bg.png);background-position: 0rem 0rem;"-->
                      <div style="position:absolute;width: 16.64rem;"><img src="images/waterstyle165_bg.png" style="width:16.64rem;"></div>
                      <h3 style="width: 13.05326rem;height: 3.63104rem;line-height: 2.63104rem;left: 1.7037rem;top: 6.21rem;color:#ffffff;text-align:center;">加水印</h3>
                      <p style="left: 2.88095rem;top: 9.13767rem;width: 10.7185rem;height: 1.7852rem;line-height: 1.7852rem;color:#ffffff;text-align:center;">微信：aqf</p>
                    </div>
                </li>
                <li data-index="8">
                        <div class="mod-mark" ><!--style="background-image: url(./images/waterstyle157_bg.png);background-position: 0rem 4.335rem;"-->
                          <div style="position:absolute;width: 16.64rem;top:4.335rem;"><img src="images/waterstyle157_bg.png" style="width:16.64rem;"></div>
                          <h3 style="width: 16.491rem;height: 2.635rem;line-height: 2.635rem;left:0rem;top: 8.245rem;color:#ffffff;text-align:center;">加水印</h3>
                          <p style="left:0rem;top: 10.801rem;width: 16.49rem;height: 1.8139rem;line-height: 1.8139rem;color:#ffffff;text-align:center;">微信：aqf</p>
                        </div>
                </li>
                <li data-index="9">
                        <div class="mod-mark" ><!--style="background-image: url(./images/waterstyle156_bg.png);background-position: 0rem 0rem;"-->
                          <div style="position:absolute;width:16.64rem;"><img src="images/waterstyle156_bg.png" style="width:16.64rem;"></div>
                          <h3 style="width: 12.697rem;height: 2.6384rem;line-height: 2.6384rem;left: 1.89635rem;top: 6.59855rem;color:#ffd800;text-align:center;">加水印</h3>
                          <p style="left: 1.89635rem;top: 9.0695rem;width: 12.6973rem;height: 1.8139rem;line-height: 1.8139rem;color:#ffd800;text-align:center;">微信：aqf</p>
                        </div>
                </li>
                <li data-index="19">
                      <div class="mod-mark" ><!--style="background-image: url(./images/waterstyle119_bg.png);background-position: 0rem 0rem;"-->
                        <div style="position:absolute;width:16.64rem;"><img src="images/waterstyle119_bg.png" style="width:16.64rem;"></div>
                        <h3 style="width: 16.49rem;height: 2.6384rem;line-height: 2.6384rem;left:0rem;top: 6.51355rem;color:#000000;text-align:center;">加水印</h3>
                        <p style="left:0rem;top: 9.15195rem;width: 16.49rem;height: 1.8139rem;line-height: 1.8139rem;color:#000000;text-align:center;">微信：aqf</p>
                      </div>
                </li>
        </ul>
        <!-- 第四步 编辑水印 -->
        <div class="addstepfour">
            <div class="markform" id="markform">
              <input data-title="title" type="text" class="h3" placeholder="输入店铺名称（必填）">
              <p class="h3">该水印最多勾选1个联系方式</p>
              <div class="l focus">
                <i class="icon"><span>√</span></i> <i class="icon1 wx iconfont">&#xe6ae;</i> <input data-img="wechat" type="text" placeholder="输入微信号"> <i class="icon2"></i>
              </div>
              <div class="l">
                <i class="icon"><span>√</span></i> <i class="icon1 wd iconfont">&#xe664;</i> <input data-img="weidian" type="text" placeholder="输入微店号" > <i class="icon2"></i>
              </div>
              <div class="l">
                <i class="icon"><span>√</span></i> <i class="icon1 taobao iconfont">&#xe64e;</i> <input data-img="taobao" type="text" placeholder="输入淘宝店名"> <i class="icon2"></i>
              </div>
              <div class="l">
                <i class="icon"><span>√</span></i> <i class="icon1 qq iconfont">&#xe604;</i> <input data-img="QQ" type="text" placeholder="输入QQ号"> <i class="icon2"></i>
              </div>
              <div class="l">
                <i class="icon"><span>√</span></i> <i class="icon1 sina iconfont">&#xe615;</i> <input data-img="weibo" type="text" placeholder="输入微博号"> <i class="icon2"></i>
              </div>
              <div style="height: .8rem;"></div>
            </div>
            <button id="create-mark" class="create-mark">生成水印</button>
        </div>
        <div class="shengchengwater">
            <div><h3>生成</h3></div>
            <p id="desnote" style="text-align:center;">修改模板上的“图片”和“文字”生成你的海报</p>
            <div style="background-color:#ffffff"></div>
        </div> 

    </div>
  </div>
    <!-- 添加水印第一个页面结束 -->
     <div class="baocun" style="display:none">
         <div class="baocunimg">
             <img src=""/>
         </div>
         <p style="width:100%;text-align:center;margin-top: 10px;">长按图片保存到手机</p>
         <div class="conshengcheng">
             <!-- <div><h3>继续生成</h3></div> -->
             <div><h3><a href="mark.html">继续生成</a></h3></div>
         </div>
     </div>
     <!-- 生成后显示页面结束 -->
    <!-- // <script src="js/powder1.5.2.js"></script>
    // <script src="js/watermark_step05.js"></script> -->
    <script src="js/jquery.panzoom.js"></script>
    <script src="js/resizediv.js"></script>
   
    <script type="text/javascript">
     //上传图片 
      $("#markimg").change(function(){
        var objUrl = getObjectURL(this.files[0]);
            console.log("objUrl = "+objUrl) ;
        if (objUrl) {
          $("#addpic").attr("src", objUrl);
          $(".add").hide();
          $(".addsteptwo").show();
          }
        });
     $("#editz35_upfile2").change(function(){
        var objUrl = getObjectURL(this.files[0]) ;
            
        if (objUrl) {
          $(".editz35_con5 img").attr("src", objUrl) ;
         
        }
      });    
       //建立一个可存取到该file的url
      function getObjectURL(file) {
        var url = null ; 
        if (window.createObjectURL!=undefined) { // basic
          url = window.createObjectURL(file) ;
        } else if (window.URL!=undefined) { // mozilla(firefox)
          url = window.URL.createObjectURL(file) ;
        } else if (window.webkitURL!=undefined) { // webkit or chrome
          url = window.webkitURL.createObjectURL(file) ;
        }
        return url ;
      }
      $(".addmark").click(function(){
          $(".addsteptwo").hide();
          $(".masklist").show();
      });
      // 选择水印样式和编辑水印的操作
      $(".mod-mark").one("click",function(){ 
          $(".mod-mark").unbind("click");
          console.log(this);
          $("#addpic").after(this);
          $(".addsteptwo").show();
          $(".mod-mark").css("left","7.905rem");
          $(".mod-mark").css("top","1.105rem");
          $(".mod-mark h3").html("输入店铺名称");
          $(".mod-mark p").html("<img src='images/icons_wechat_white.png'><span>输入微信号</span>");
          // var src1=$(".mod-mark").css("background-image");
          // var us1=src1.indexOf('images');
          // var u2=src1.indexOf('"',us1);
          // var imgsrc1=src1.slice(us1,u2);
          // console.log(imgsrc1);
          // $(".mod-mark h3").before("<img src='"+imgsrc1+"' style='width:100%;height:100%'/>");
          // $(".mod-mark").css("background-image","none");
          $(".addstepfour").show();
          $(".addmark").hide();
          $(".markmain").css("margin-top","0rem");
          $(".masklist").hide();
      });
     
      $(".markform input.h3").focus(function(){
          var ped=$(this).val();
          ""==ped && (ped=$(this).attr("placeholder")),
          $(".mod-mark h3").html(ped);
          console.log(ped);
          // $(this).css("color","#ababab");
      });
      // $(".markform input.h3").click(function(){
      //     $(".mod-mark h3").html($(".markform input.h3").val());
      // });
      $(".markform input.h3").keyup(function(){
          var valh3=$(".markform input.h3").val();
          $(".mod-mark h3").html(valh3);
      });
      $(".markform input.h3").blur(function(){
          $(".mod-mark h3").html($(".markform input.h3").val());
      });
      // 
      $(".l").click(function(){
          $(this).addClass("focus");
          $(this).siblings().removeClass("focus");
          //获取选择的图片路径
          var urlimg=$(this).children(".icon1").css("background-image");
          console.log(urlimg);
          var ustart=urlimg.indexOf('images');
          var ulast=urlimg.indexOf('"',ustart)
          console.log(ustart+','+ulast);
          var imgsrc=urlimg.slice(ustart,ulast);
          console.log(imgsrc);
          // alert(imgsrc);
          var ped2;
          ped2=$(this).children('input').val();
          ""==ped2 && (ped2=$(this).children('input').attr("placeholder")),
          $(".mod-mark p span").html(ped2);
          
          $(".mod-mark p img").attr("src",imgsrc);
          // $(".mod-mark p span").html($(this).children('input').attr("placeholder"));

          $(this).children('input').keyup(function(){
              $(".mod-mark p span").html($(this).val());
              console.log($(this).val());
          });
          
      });
      //点击生成水印
      $(".create-mark").click(function(){
          $(".addstepfour").hide();
          $(".shengchengmark").show();
          // $(".markmain").css("margin-top","7rem");
          $(".mod-mark").addClass("edit");
          $(".mod-mark").css("top","4.25rem");
          $(".mod-mark").attr("id","markmove");
          html2canvas($(".mod-mark"), {
                        allowTaint: true,
                        taintTest: false,
                        onrendered: function(canvas) {
                            canvas.id = "mycanvas";
                            var dataUrlw = canvas.toDataURL("image/png");
                             $.ajax({  
                              type : "POST",  
                              url : '1.php',  
                              data : {data:dataUrlw},  
                              // timeout : 60000,  
                              success : function(data){  
                                  var srcw=data;  
                                  // $(".markh3").hide();
                                  // $(".markp").hide();
                                  $(".edit p").hide();
                                  $(".edit h3").hide();
                                  $(".edit div img").attr("src",srcw);
                                  console.log("已生成");
                              }  
                            });
                          
                        }
          });
         $("#markmove").resize(function(){
           addScale();
           console.log("hh");
           // alert("gfgg")
         });
          addLis();
          // $("#markmove").panzoom();
          // drag();
         
          // ty();
          // touchjs();
          
      });
      $(".shengchengmark").click(function(){
              $("body").css("background","none");
                $(".mod-mark").css("box-shadow","none");
                $("#markmove").css("background-image");
                console.log($("#markmove").css("background-image"));
                var src1=$("#markmove").css("background-image");
                var us1=src1.indexOf('images');
                var u2=src1.indexOf('"',us1);
                var imgsrc1=src1.slice(us1,u2);
                console.log(imgsrc1);
                
                // $("#markmove").css({
                //   "background":"none",
                //   "background-repeat":"no-repeat",
                //   "background-size":"contain"
                // });
                
                console.log($("#markmove").css("background-image"));
                
                $(".shengchengmark").hide();
                // $(".edit3").show();
                $(".editz35_up1").hide();
                $(".editz35_up2").hide();
                $(".header").hide();
                $("body").css("background","none");
                
                html2canvas($(".markmain"), {
                        allowTaint: true,
                        taintTest: false,
                        onrendered: function(canvas) {
                            canvas.id = "mycanvas";
                            //document.body.appendChild(canvas);
                            //生成base64图片数据
                            $(".header").show();
                            $(".baocun").show();
                            
                            var dataUrl = canvas.toDataURL("image/png");
                             $.ajax({  
                              type : "POST",  
                              url : '1.php',  
                              data : {data:dataUrl},  
                              // timeout : 60000,  
                              success : function(data){  
                                  var src=data;  
                                  $(".baocunimg img").attr("src",src) ;
                              }  
                            });  
                            // $(".baocunimg img").attr("src",dataUrl) ;
                            $(".addsteptwo").hide();
                            console.log("已生成");
                        }
                });
        });
    function ty(){
      var handleTouchyPinch = function (e, $target, data) {
          $target.css({'webkitTransform':'scale(' + data.scale + ',' + data.scale + ')'});
          alert(data.scale);
      };
      $('#markmove').bind('touchy-pinch', handleTouchyPinch);
    }
    //加水印页面结束
    function addLis(){
        //获取节点
      var water = document.getElementById("markmove");
      var oW20,oH20;
      // 绑定touchstart事件
      water.addEventListener("touchstart", function(e) {
        console.log(e);
        var touches = e.touches[0];
        oW20 = touches.clientX -water.offsetLeft;
        oH20 = touches.clientY -water.offsetTop;
       //阻止页面的滑动默认事件
        document.addEventListener("touchmove",defaultEvent,false);
      },false)
     
      water.addEventListener("touchmove", function(e) {
        var touches = e.touches[0];
        var oLeft = touches.clientX - oW20;
        var oTop = touches.clientY - oH20;
        if(oLeft < -50) {
          oLeft = -50;
          console.log(window.innerWidth);
         }else if(oLeft > document.documentElement.clientWidth-water.offsetWidth) {
          console.log(document.documentElement.clientWidth-water.offsetWidth);
          oLeft = document.documentElement.clientWidth-water.offsetWidth;
         }
        if(oTop < -50) {
          oTop = -50;
         }else if(oTop > 640) {
          console.log(document.documentElement.clientHeight-water.offsetHeight);
          oTop = document.documentElement.clientHeight-water.offsetHeight;
         }
        water.style.left = oLeft/20 + "rem";
        water.style.top = oTop/20 + "rem";
        // water.style.transform="translate("+oLeft/20+ "rem,"+oTop/20+"rem) ";
        // water.style.webkitTransform="translate("+oLeft/20+ "rem,"+oTop/20+"rem)";
      },false);
       
      water.addEventListener("touchend",function() {
        document.removeEventListener("touchmove",defaultEvent,false);
      },false);
      function defaultEvent(e) {
        e.preventDefault();
      }
    }
    function addScale(){
      <!-- 监听手势 缩放-->
    
      var target12= document.getElementById("markmove");
      // target12.style.webkitTransition = 'all ease 0.05s';

      touch.on('#markmove', 'touchstart', function(ev){
          ev.preventDefault();
      });

      var initialScale = 1;
      var currentScale;
      var angle=0;
      var totalAngle;


      // var dx, dy;

      // touch.on('#markmove', 'drag', function(ev){
      //   dx = dx || 0;
      //   dy = dy || 0;
      //   console.log("当前x值为:" + dx + ", 当前y值为:" + dy +".");
      //   var offx = dx + ev.x;
      //   var offy = dy + ev.y;
      //   this.style.webkitTransform = "translate3d(" + offx/20 + "rem," + offy/20 + "rem,0)";
      // });

      // touch.on('#markmove', 'dragend', function(ev){
      //   dx += ev.x;
      //   dy += ev.y;
      // });

      touch.on('#markmove', 'pinchend rotate', function(ev){
         currentScale = ev.scale-1;
          console.log(currentScale);
          // alert(ev.fingerStatus);
          // ev.startRotate();
          var totalAngle = angle + ev.rotation;
          // if(ev.fingerStatus === 'end'){
          //     angle = angle + ev.rotation;
          // }
          if(ev.fingerStatus === 'move'&& ev.fingersCount===2){
            // alert(ev.fingersCount);
          currentScale = initialScale + currentScale;
          currentScale = currentScale > 2.5 ? 2.5 : currentScale;
          currentScale = currentScale < 1 ? 1 : currentScale;
          this.style.webkitTransform = 'scale(' + currentScale + ') rotate3d(0,0,1,' + totalAngle + 'deg)';
          this.style.left=target12.offsetLeft;
          this.style.top=target12.offsetTop;

         }else{
          ev.preventDefault();
          ev.stopPropagation();
         }
         // if(ev.fingersCount===1){
         //    alert(ev.fingersCount);
         //    this.style.webkitTransform='translate('+target12.clientX/20+'rem,'+target12.clientY/20+'rem)';
         //  }

          // alert(this.style.fontSize);
          console.log("当前缩放比例为:" + currentScale + ".");
      });

      touch.on('#markmove', 'pinchend', function(ev){
          initialScale = currentScale;
      });

    }
    function drag(){
      touch.on('#markmove', 'touchstart', function(ev){
          ev.preventDefault();
        });

        var targetd = document.getElementById("markmove");
        var dx, dy;

        touch.on('#markmove', 'drag', function(ev){
          dx = dx || 0;
          dy = dy || 0;
          console.log("当前x值为:" + dx + ", 当前y值为:" + dy +".");
          var offx = dx + ev.x + "px";
          var offy = dy + ev.y + "px";
          this.style.webkitTransform = "translate3d(" + offx + "," + offy + ",0)";
        });

        touch.on('#markmove', 'dragend', function(ev){
          dx += ev.x;
          dy += ev.y;
        });
    }
    function touchjs(){
        /** 调用 **/
        //实例Touch对象
        var MyTouch = new Touch();
        //实例TouchSlide
        var TouchSlide = new MyTouch.TouchSlide({
            //传入目标元素
            target: '#markmove'
        });
        //调用拖拽
        TouchSlide.onDrag();
    }
    
    </script>
   
</body>
</html>